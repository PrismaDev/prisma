var LayoutStringsModel = Backbone.Model.extend({
	defaults: {
		'hiStr': 'Olá',
		'loginStr': 'Login',
		'logoutStr': 'Logout',
		'commentsStr': 'Sugestões',
		'FAQStr': 'FAQ',
		'tutorialStr': 'Vídeo tutorial',
		'projectNameStr': 'PrISMA',
		'userName': 'Bobteco da Silva',
		'footerText': 'Esse projeto é uma colaboração dos alunos\
			Julio Ribeiro, Luiza Silva, Gabriel Martinelli,\
			André Marçal, Denis Neves, Glauber Borges e\
			Maurício Fragale com o professor Sérgio Lifschitz. \
			Contato: prisma@inf.puc-rio.br'
	}
});

var layoutStringsModel = new LayoutStringsModel();
LayoutView = Backbone.View.extend({
	el: 'body',
	template: '',
	contentView: null,
	loggedIn: false,
	dialogDiv: '#dialogDiv',

	events: {
		'click #open-suggestions-link': 'openSuggestionDialog',
		'click ul div.dropdown-menu': 'preventClose'
	},

	openSuggestionDialog: function() {
		suggestionsView.render();
		$('#dialogDiv').modal('show');
	},

	preventClose: function(e) {
		e.stopPropagation();
	},

	initialize: function() {
		this.template = _.template($('#layout-template').html());
	},

	initJS: function() {
		$('.dropdown-toggle').dropdown();
	},

	setView: function(view) {
		this.contentView=view;
	},

	prepareDialogs: function() {
		if (this.loggedIn) {
			suggestionsView.setElement(this.dialogDiv);
		}
	},
	
	render: function() {
		var args = {
			layoutStr: layoutStringsModel,
			loggedIn: this.loggedIn
		};

		if (!this.loggedIn)
			args={
				layoutStr: layoutStringsModel,
				loggedIn: this.loggedIn,
				loginStr: loginStringsModel
			};

		this.$el.html(this.template(args));	
		this.prepareDialogs();
		this.initJS();
	
		if (this.contentView) 
			this.contentView.setElement('#content-div');
	}
});

var layoutView = new LayoutView();
var DialogView = Backbone.View.extend({
	el: '',
	template: '',	
	args: '',
	templateId: '',
	
	initialize: function() {
		this.template = _.template($(this.templateId).html());
	},

	initJS: function() {
		this.$el.modal();
	},

	render: function() {
		this.$el.html(this.template(this.args));
		this.initJS();
	}
});

var FAQView = DialogView.extend({
	args: {
		layoutStr: layoutStringsModel
	},
	templateId: '#faq-template'
});
var LoginStringsModel = Backbone.Model.extend({
	defaults: {
		'matriculaLabel': 'Matrícula',
		'passwordLabel': 'Senha',
		'submitButtonLabel': 'Login',
		'loginHelpText': 'Para logar, use sua matrícula sem o\
			dígito verificador e a mesma senha que você utiliza\
			para o PUC Online',
		'forgotPasswordText': 'Se você esqueceu sua senha, <a href=\
			"http://www.puc-rio.br/ensinopesq/academicas/">clique aqui</a>\
			 para acessar o PUC Online e recuperá-la',
		'infoText': 'O PrISMA, Programa de Instrução à Solicitação da\
			Matrícula Acadêmica, é um sistema desenvolvido por alunos\
			em parceria com o professor Sérgio Lifschitz que tem como\
			objetivo facilitar o preenchimento da primeira fase da\
			matrícula',
		'openLoginButtonLabel': 'Fazer login',
		'tutorialButtonLabel': 'Tutorial - em breve!',
		'invalidLoginErrorMsg': 'Login e/ou senha inválidos!',
		'accessDeniedErrorMsg': 'Você precisa se logar para acessar essa página',
		'pageDoesNotExistErrorMsg': 'A página que você está acessando não existe no nosso sistema',
		'unexpectedErrorMsg': 'O sistema se comportou de forma inesperada - fique tranquilo,\
			recebemos o erro e assim que possível ele será corrigido'
	}
});

var loginStringsModel = new LoginStringsModel();
var LoginView = Backbone.View.extend({
	el: '',
	template: '',

	events: {
		'click #open-login-button': 'openLogin' 
	},

	openLogin: function() {
		$('#open-login-button-container').addClass('hidden');
		$('#login-form-container').removeClass('hidden');
	},

	initialize: function() {
		this.template = _.template($('#login-template').html());
	},

	render: function(error) {
		if (error==undefined)
			error=false;
		console.log(error);

		this.$el.html(this.template({
			loginStr: loginStringsModel,
			layoutStr: layoutStringsModel,
			error: error
		}));
	}
});

var loginView = new LoginView();
var LoginRouter = Backbone.Router.extend({
	routes: {
		'': 'login',
		'*span': 'other'
	},

	loadPage: function(error) {
		layoutView.setView(loginView);
		layoutView.loggedIn=false;
		layoutView.render();		
	
		loginView.render(error);
	}
});

var loginRouter = new LoginRouter();

loginRouter.on('route:other', function() {
	this.navigate('', {trigger: true});
});

loginRouter.on('route:login', function() {
	var arr = document.URL.split('?');
	var error=false;	

	if (arr.length>1)
		error = arr[1].split('#')[0];
	this.loadPage(error);
});

//if (history.pushState) { 
//	console.log("pushState supported");
//	Backbone.history.start({pushState: true});
//}
//else {
//	console.log("pushState NOT supported");
	Backbone.history.start();
//}
