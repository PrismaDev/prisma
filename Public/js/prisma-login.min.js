var LayoutStringsModel = Backbone.Model.extend({
	defaults: {
		'hiStr': 'Olá',
		'loginStr': 'Login',
		'logoutStr': 'Logout',
		'commentsStr': 'Sugestões',
		'FAQStr': 'FAQ',
		'tutorialStr': 'Vídeo-tutorial',
		'codTutorialYoutube': 'XHF8WOJ6xI0',
		'projectNameStr': 'PrISMA',
		'userName': 'Bobteco da Silva',
		'footerText': 'Esse projeto é uma colaboração dos alunos\
			Julio Ribeiro, Luiza Silva, Gabriel Martinelli,\
			André Marçal, Denis Neves, Glauber Borges e\
			Maurício Fragale com o professor Sérgio Lifschitz. \
			Contato: prisma@inf.puc-rio.br'
	}
});

var layoutStringsModel = new LayoutStringsModel();
var FAQStringsModel = Backbone.Model.extend({
	defaults: {
		'dialogTitle': 'FAQ',
		'answerStr': 'Resposta:',
		'questionStr': 'Pergunta:',
		'questionList': [
			{
				'question': 'Não consigo logar no sistema.',
				'answer': 'Verifique se suas credenciais do PUC Online estão corretas. Caso positivo, verifique se seu navegador está configurado para aceitar COOKIES.'
			},
			{
				'question': 'O que significa cada cor na tabela de falta-cursar?',
				'answer': 'Vermelho: disciplina presa por algum pré-requisito;\nAmarelo: disciplina que você está cursando ou que está presa por algum pré-requisito que você está cursando;\nBranco: você está "apto" a cursar. Sugerimos verificar ementa no site da PUC para comprovar aptidão.\nAzul: disciplina selecionada. Suas turmas estão sendo exibidas;'
			},
			{
				'question': 'Como adiciono turma?',
				'answer': 'Basta clicar na turma em questão.'
			},
			{
				'question': 'Como removo turma?',
				'answer': 'Clique nela novamente.\nOu então a visualize na aba de selecionadas e clique no botão "x".'
			},
			{
				'question': 'Como sei que a turma foi inserida?',
				'answer': 'É apresentada uma notificação na aba de selecionadas e aparece na tabela de horarios em cores sempre distintas.'
			},
			{
				'question': 'Como adiciono disciplinas que não estão no meu falta cursar?',
				'answer': 'Basta procurar a turma na aba de micro horário e clicar na disciplina e depois na turma desejada.'
			},
			{
				'question': 'O que fazer na tela de selecionada?',
				'answer': 'Você pode fazer o que quiser, basicamente. Tanto trocar as turmas de posição movendo-as para um lugar vazio, quanto trocando-as de lugar com alguma outra. Assim como também é possível trocar as linhas de ordem.'
			},
			{
				'question': 'Mas por que isso é importante?',
				'answer': 'Porque o PUC Online funciona assim. Ao fazer o processamento das disciplinas, as disciplinas mais prioritárias serão aquelas que estão nas primeiras linhas e primeiras opções. Desta maneira, você pode trocar a prioridade de todas as turmas escolhidas simplesmente arrastando elas para onde você quiser.'
			},
			{
				'question': 'Ok, mas e daí?',
				'answer': 'Daí que você pode usar a magica funcionalidade dos radio buttons, apresentados logo do lado esquerdo de cada lugar que pode receber uma turma. Esses radio buttons representam a turma que foi possível de pegar na simulação.'
			},
			{
				'question': 'Simulação? Como funciona?',
				'answer': 'Tem por objetivo simular o que pode acontecer com a sua solicitação de matrícula no PUC Online.\nTendo conhecimento da priorização das primeiras linhas e primeiras opções, a simulação tenta sempre pegar as turmas nesse sentido do processamento. Isto é, você pode simular as opções que serão pegas em cada linha. Automaticamente será realizada uma cascata nas linhas menos prioritárias de forma a mostrar o que realmente aconteceria caso aquela opção fosse pega.'
			},
			{
				'question': 'Legal. Montei minha grade, e agora?',
				'answer': 'Infelizmente sua grade está salva em nosso sistema, mas não no PUC Online. Você deve entrar com os dados que foram gerados aqui no sistema de requisição de matrícula acadêmica, que fica localizado dentro do PUC Online.'
			},
			{
				'question': 'O sistema apresenta erros / não funciona no meu navegador.',
				'answer': 'Infelizmente o sistema foi desenvolvido tirando proveito de recursos não suportados por browsers muito antigos. Recomendo a utilização da versão mais recente do seu browser favorito. Não esqueça de nos notificar o bug para que possamos tentar consertá-lo; utilize o campo de sugestões para tal\n\Obs: o site pode estar não completamente funcional no Internet Explorer. Recomendamos o uso de algum outro navegador popular disponível atualmente. Aqueles que recomendamos são: Google Chrome, Mozilla Firefox, Opera.'
			}
		]
	}
});

var faqStringsModel = new FAQStringsModel();
LayoutView = Backbone.View.extend({
	el: 'body',
	template: '',
	contentView: null,
	loggedIn: false,
	dialogDiv: '#dialog-div',

	events: {
		'click #open-suggestions-link': 'openSuggestionDialog',
		'click #open-faq-link': 'openFAQDialog',
		'click #open-tutorial-link': 'openTutorialDialog',
		'click ul div.dropdown-menu': 'preventClose'
	},

	openSuggestionDialog: function() {
		suggestionsView.render();
		$(this.dialogDiv).modal('show');
	},

	openFAQDialog: function() {
		faqView.render();
		$(this.dialogDiv).modal('show');
	},

	openTutorialDialog: function() {
		tutorialView.render();
		$(this.dialogDiv).modal('show');
	},

	preventClose: function(e) {
		e.stopPropagation();
	},

	initialize: function() {
		this.template = _.template($('#layout-template').html());
	},

	initJS: function() {
		$('.dropdown-toggle').dropdown();
		fbApiController.loadApi();
	},

	setView: function(view) {
		this.contentView=view;
	},

	prepareDialogs: function() {
		if (this.loggedIn) {
			suggestionsView.setElement(this.dialogDiv);
		}
		
		faqView.setElement(this.dialogDiv);
		tutorialView.setElement(this.dialogDiv);
	},
	
	render: function() {
		var args = {
			layoutStr: layoutStringsModel,
			loggedIn: this.loggedIn
		};

		if (!this.loggedIn)
			args={
				layoutStr: layoutStringsModel,
				loggedIn: this.loggedIn,
				loginStr: loginStringsModel
			};

		this.$el.html(this.template(args));	
		this.prepareDialogs();
		this.initJS();
	
		if (this.contentView) 
			this.contentView.setElement('#content-div');
	}
});

var layoutView = new LayoutView();
var DialogView = Backbone.View.extend({
	el: '',
	template: '',	
	args: '',
	templateId: '',
	
	initialize: function() {
		this.template = _.template($(this.templateId).html());
	},

	initJS: function() {
		this.$el.modal();
	},

	render: function() {
		this.$el.html(this.template(this.args));
		this.initJS();
	}
});

var FAQView = DialogView.extend({
	args: {
		faqStr: faqStringsModel
	},
	templateId: '#faq-template'
});

var faqView = new FAQView();

var TutorialView = DialogView.extend({
	args: {
		layoutStr: layoutStringsModel
	},
	templateId: '#tutorial-template',
	player: null,

	initJS: function() {
		//From github.com/twitter/bootstrap/issues/675/

		var me=this;
		this.$el.modal().css({
			'margin-left': function() {
				return -($(this).width()/2);
			}
		}).addClass('tutorial').on('hidden', function() {
			me.$el.empty();
			me.$el.removeClass('tutorial');
		});

		this.player = new YT.Player('yt-player', {
			height: '390',
			width: '640',
			videoId: layoutStringsModel.get('codTutorialYoutube')
		});
	}
});

var tutorialView = new TutorialView();
function FbApiController() {
	var me=this;

	this.loadApi = function() {
		me.insertScript(document,true);
	}

	this.insertScript = function(element, debug) {
		var js, id = 'facebook-jssdk', ref = element.getElementById('fb-root');
		if (element.getElementById(id)) {return;}
		js = element.createElement('script'); js.id = id; js.async = true;
		js.src = "//connect.facebook.net/en_US/all" + (debug ? "/debug" : "") + ".js";
		ref.parentNode.insertBefore(js, ref);
	}

	window.fbAsyncInit = function() {
    		FB.init({
			status     : false,
			cookie     : true, // set sessions cookies to allow your server to access the session?
			xfbml      : true  // parse XFBML tags on this page?
		});
	};
}

var fbApiController = new FbApiController();
var LoginStringsModel = Backbone.Model.extend({
	defaults: {
		'matriculaLabel': 'Matrícula',
		'matriculaMaxLength': '7',
		'passwordLabel': 'Senha',
		'passwordMaxLength': '8',
		'submitButtonLabel': 'Login',
		'loginHelpText': 'Para logar, use sua matrícula sem o\
			dígito verificador e a mesma senha que você utiliza\
			para o PUC Online',
		'forgotPasswordText': 'Se você esqueceu sua senha, <a href=\
			"http://www.puc-rio.br/ensinopesq/academicas/">clique aqui</a>\
			 para acessar o PUC Online e recuperá-la',
		'infoText': 'O PrISMA, Programa de Instrução à Solicitação da\
			Matrícula Acadêmica, é um sistema desenvolvido por alunos\
			em parceria com o professor Sérgio Lifschitz que tem como\
			objetivo facilitar o preenchimento da primeira fase da\
			matrícula',
		'openLoginButtonLabel': 'Fazer login',
		'tutorialButtonLabel': 'Tutorial',
		'invalidLoginErrorMsg': 'Login e/ou senha inválidos!',
		'accessDeniedErrorMsg': 'Você precisa se logar para acessar essa página',
		'pageDoesNotExistErrorMsg': 'A página que você está acessando não existe no nosso sistema',
		'unexpectedErrorMsg': 'O sistema se comportou de forma inesperada - fique tranquilo,\
			recebemos o erro e assim que possível ele será corrigido'
	}
});

var loginStringsModel = new LoginStringsModel();
var LoginView = Backbone.View.extend({
	el: '',
	template: '',

	events: {
		'click #open-login-button': 'openLogin',
		'click #open-tutorial-button': 'openTutorial'
	},

	openTutorial: function() {
		layoutView.openTutorialDialog();
	},

	openLogin: function() {
		$('#open-login-button-container').addClass('hidden');
		$('#login-form-container').removeClass('hidden');
	},

	initialize: function() {
		this.template = _.template($('#login-template').html());
	},

	render: function(error) {
		if (error==undefined)
			error=false;

		this.$el.html(this.template({
			loginStr: loginStringsModel,
			layoutStr: layoutStringsModel,
			error: error
		}));
	}
});

var loginView = new LoginView();
var LoginRouter = Backbone.Router.extend({
	routes: {
		'': 'login',
		'*span': 'other'
	},

	loadPage: function(error) {
		layoutView.setView(loginView);
		layoutView.loggedIn=false;
		layoutView.render();		
	
		loginView.render(error);
	}
});

var loginRouter = new LoginRouter();

loginRouter.on('route:other', function() {
	this.navigate('', {trigger: true});
});

loginRouter.on('route:login', function() {
	var arr = document.URL.split('?');
	var error=false;	

	if (arr.length>1)
		error = arr[1].split('#')[0];
	this.loadPage(error);
});

//if (history.pushState) { 
//	console.log("pushState supported");
//	Backbone.history.start({pushState: true});
//}
//else {
//	console.log("pushState NOT supported");
	Backbone.history.start();
//}
