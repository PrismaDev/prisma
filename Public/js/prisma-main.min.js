var LayoutStringsModel=Backbone.Model.extend({defaults:{hiStr:"Ol\u00e1",loginStr:"Login",logoutStr:"Logout",commentsStr:"Sugest\u00f5es",updatesStr:"Updates",FAQStr:"FAQ",tutorialStr:"V\u00eddeo-tutorial",codTutorialYoutube:"XHF8WOJ6xI0",projectNameStr:"PrISMA",userName:"Bobteco da Silva",footerText:"Esse projeto \u00e9 uma colabora\u00e7\u00e3o dos alunos\t\t\tJulio Ribeiro, Luiza Silva, Gabriel Martinelli,\t\t\tAndr\u00e9 Mar\u00e7al, Denis Neves, Glauber Borges e\t\t\tMaur\u00edcio Fragale com o professor S\u00e9rgio Lifschitz. \t\t\tContato: prisma@inf.puc-rio.br"}}),
layoutStringsModel=new LayoutStringsModel,FAQStringsModel=Backbone.Model.extend({defaults:{dialogTitle:"FAQ",answerStr:"Resposta:",questionStr:"Pergunta:",questionList:[{question:"N\u00e3o consigo logar no sistema.",answer:"Verifique se suas credenciais do PUC Online est\u00e3o corretas. Caso positivo, verifique se seu navegador est\u00e1 configurado para aceitar COOKIES."},{question:"O que significa cada cor na tabela de falta-cursar?",answer:'Vermelho: disciplina presa por algum pr\u00e9-requisito;\nAmarelo: disciplina que voc\u00ea est\u00e1 cursando ou que est\u00e1 presa por algum pr\u00e9-requisito que voc\u00ea est\u00e1 cursando;\nBranco: voc\u00ea est\u00e1 "apto" a cursar. Sugerimos verificar ementa no site da PUC para comprovar aptid\u00e3o.\nAzul: disciplina selecionada. Suas turmas est\u00e3o sendo exibidas;'},
{question:"Como adiciono turma?",answer:"Basta clicar na turma em quest\u00e3o."},{question:"Como removo turma?",answer:'Clique nela novamente.\nOu ent\u00e3o a visualize na aba de selecionadas e clique no bot\u00e3o "x".'},{question:"Como sei que a turma foi inserida?",answer:"\u00c9 apresentada uma notifica\u00e7\u00e3o na aba de selecionadas e aparece na tabela de horarios em cores sempre distintas."},{question:"Como adiciono disciplinas que n\u00e3o est\u00e3o no meu falta cursar?",answer:"Basta procurar a turma na aba de micro hor\u00e1rio e clicar na disciplina e depois na turma desejada."},
{question:"O que fazer na tela de selecionada?",answer:"Voc\u00ea pode fazer o que quiser, basicamente. Tanto trocar as turmas de posi\u00e7\u00e3o movendo-as para um lugar vazio, quanto trocando-as de lugar com alguma outra. Assim como tamb\u00e9m \u00e9 poss\u00edvel trocar as linhas de ordem."},{question:"Mas por que isso \u00e9 importante?",answer:"Porque o PUC Online funciona assim. Ao fazer o processamento das disciplinas, as disciplinas mais priorit\u00e1rias ser\u00e3o aquelas que est\u00e3o nas primeiras linhas e primeiras op\u00e7\u00f5es. Desta maneira, voc\u00ea pode trocar a prioridade de todas as turmas escolhidas simplesmente arrastando elas para onde voc\u00ea quiser."},
{question:"Ok, mas e da\u00ed?",answer:"Da\u00ed que voc\u00ea pode usar a magica funcionalidade dos radio buttons, apresentados logo do lado esquerdo de cada lugar que pode receber uma turma. Esses radio buttons representam a turma que foi poss\u00edvel de pegar na simula\u00e7\u00e3o."},{question:"Simula\u00e7\u00e3o? Como funciona?",answer:"Tem por objetivo simular o que pode acontecer com a sua solicita\u00e7\u00e3o de matr\u00edcula no PUC Online.\nTendo conhecimento da prioriza\u00e7\u00e3o das primeiras linhas e primeiras op\u00e7\u00f5es, a simula\u00e7\u00e3o tenta sempre pegar as turmas nesse sentido do processamento. Isto \u00e9, voc\u00ea pode simular as op\u00e7\u00f5es que ser\u00e3o pegas em cada linha. Automaticamente ser\u00e1 realizada uma cascata nas linhas menos priorit\u00e1rias de forma a mostrar o que realmente aconteceria caso aquela op\u00e7\u00e3o fosse pega."},
{question:"Legal. Montei minha grade, e agora?",answer:"Infelizmente sua grade est\u00e1 salva em nosso sistema, mas n\u00e3o no PUC Online. Voc\u00ea deve entrar com os dados que foram gerados aqui no sistema de requisi\u00e7\u00e3o de matr\u00edcula acad\u00eamica, que fica localizado dentro do PUC Online."},{question:"O sistema apresenta erros / n\u00e3o funciona no meu navegador.",answer:"Infelizmente o sistema foi desenvolvido tirando proveito de recursos n\u00e3o suportados por browsers muito antigos. Recomendo a utiliza\u00e7\u00e3o da vers\u00e3o mais recente do seu browser favorito. N\u00e3o esque\u00e7a de nos notificar o bug para que possamos tentar consert\u00e1-lo; utilize o campo de sugest\u00f5es para tal\nObs: o site pode estar n\u00e3o completamente funcional no Internet Explorer. Recomendamos o uso de algum outro navegador popular dispon\u00edvel atualmente. Aqueles que recomendamos s\u00e3o: Google Chrome, Mozilla Firefox, Opera."}]}}),
faqStringsModel=new FAQStringsModel;
LayoutView=Backbone.View.extend({el:"body",template:"",contentView:null,loggedIn:!1,dialogDiv:"#dialog-div",events:{"click #open-suggestions-link":"openSuggestionDialog","click #open-faq-link":"openFAQDialog","click #open-tutorial-link":"openTutorialDialog","click #open-updates-link":"openUpdatesDialog","click ul div.dropdown-menu":"preventClose"},openSuggestionDialog:function(){suggestionsView.render();$(this.dialogDiv).modal("show")},openFAQDialog:function(){faqView.render();$(this.dialogDiv).modal("show")},
openTutorialDialog:function(){tutorialView.render();$(this.dialogDiv).modal("show")},openUpdatesDialog:function(){updatesView.render();updatesView.initTwitter();$(this.dialogDiv).modal("show")},preventClose:function(a){a.stopPropagation()},initialize:function(){this.template=_.template($("#layout-template").html())},initJS:function(){$(".dropdown-toggle").dropdown();fbApiController.loadApi()},setView:function(a){this.contentView=a},prepareDialogs:function(){this.loggedIn&&(suggestionsView.setElement(this.dialogDiv),
updatesView.setElement(this.dialogDiv));faqView.setElement(this.dialogDiv);tutorialView.setElement(this.dialogDiv)},render:function(){var a={layoutStr:layoutStringsModel,loggedIn:this.loggedIn};this.loggedIn||(a={layoutStr:layoutStringsModel,loggedIn:this.loggedIn,loginStr:loginStringsModel});this.$el.html(this.template(a));this.prepareDialogs();this.initJS();this.contentView&&this.contentView.setElement("#content-div")}});
var layoutView=new LayoutView,DialogView=Backbone.View.extend({el:"",template:"",args:{},templateId:"",initialize:function(){this.template=_.template($(this.templateId).html())},initJS:function(){this.$el.modal()},render:function(){this.$el.html(this.template(this.args));this.initJS()}}),FAQView=DialogView.extend({args:{faqStr:faqStringsModel},templateId:"#faq-template"}),faqView=new FAQView,TutorialView=DialogView.extend({args:{layoutStr:layoutStringsModel},templateId:"#tutorial-template",player:null,
initJS:function(){var a=this;this.$el.modal().css({"margin-left":function(){return-($(this).width()/2)}}).addClass("tutorial").on("hidden",function(){a.$el.empty();a.$el.removeClass("tutorial")});this.player=new YT.Player("yt-player",{height:"390",width:"640",videoId:layoutStringsModel.get("codTutorialYoutube")})}}),tutorialView=new TutorialView;
function FbApiController(){var a=this;this.loadApi=function(){a.insertScript(document,!0)};this.insertScript=function(a,c){var d,e=a.getElementById("fb-root");a.getElementById("facebook-jssdk")||(d=a.createElement("script"),d.id="facebook-jssdk",d.async=!0,d.src="//connect.facebook.net/en_US/all"+(c?"/debug":"")+".js",e.parentNode.insertBefore(d,e))};window.fbAsyncInit=function(){FB.init({status:!1,cookie:!0,xfbml:!0,channelUrl:"//prisma.inf.puc-rio.br/channel.php"})}}
var fbApiController=new FbApiController,SuggestionsStringsModel=Backbone.Model.extend({defaults:{dialogTitle:"Sugest\u00f5es/Bugs/Coment\u00e1rios...",submitButtonLabel:"Enviar coment\u00e1rio",resetButtonLabel:"Limpar campo"}}),suggestionsStringsModel=new SuggestionsStringsModel,UpdatesStringsModel=Backbone.Model.extend({defaults:{dialogTitle:"\u00daltimos updates do PrISMA"}}),updatesStringsModel=new UpdatesStringsModel,SuggestionsView=DialogView.extend({templateId:"#suggestions-template",args:{suggestionsStr:suggestionsStringsModel},
suggestionsUrl:"/api/sugestao",events:{"submit #suggestions-form":"sendSuggestion","keypress textarea":"toggleButton"},toggleButton:function(a){""==a.target.value.trim()?$('#suggestions-form input[type="submit"]').addClass("disabled"):$('#suggestions-form input[type="submit"]').removeClass("disabled")},sendSuggestion:function(){if($('#suggestions-form input[type="submit"]').hasClass("disabled"))return!1;$.ajax({url:this.suggestionsUrl,type:"POST",data:$("#suggestions-form").serialize(),success:function(){$("#dialog-div").modal("hide")}});
return!1}}),suggestionsView=new SuggestionsView,UpdatesView=DialogView.extend({templateId:"#updates-template",args:{updatesStr:updatesStringsModel},initTwitter:function(){twttr.widgets.load()}}),updatesView=new UpdatesView;function overriddenGet(a,b){var c=serverDictionary.get(b);return Backbone.Model.prototype.get.call(a,c)}
function overriddenAdd(a,b,c,d,e){var f=[],d=serverDictionary.get(d);e||(e={});_.each(b,function(b){typeof b==a.model?a.add(b):(b=new a.model($.extend({},e,{id:b[d]},b)),f.push(b))});return Backbone.Collection.prototype.add.call(a,f,c)}
var ServerDictionary=Backbone.Model.extend({defaults:{Dependencia:"Dependencia",FaltaCursar:"FaltaCursar",Selecionada:"Selecionada",MicroHorario:"MicroHorario",Disciplinas:"Disciplinas",Turmas:"Turmas",Optativas:"Optativas",Horarios:"Horarios",CodigoDisciplina:"CodigoDisciplina",CodigoTurma:"CodigoTurma",CodigoOptativa:"CodigoOptativa",PK_Turma:"PK_Turma",FK_Turma:"FK_Turma",NomeDisciplina:"NomeDisciplina",NomeProfessor:"NomeProfessor",NomeOptativa:"NomeOptativa",Creditos:"Creditos",Situacao:"Situacao",
Apto:"Apto",Vagas:"Vagas",Destino:"Destino",HorasDistancia:"HorasDistancia",PeriodoAno:"PeriodoAno",Tentativas:"Tentativas",Opcao:"Opcao",NoLinha:"NoLinha",DiaSemana:"DiaSemana",HoraInicial:"HoraInicial",HoraFinal:"HoraFinal"}}),serverDictionary=new ServerDictionary,MainStringsModel=Backbone.Model.extend({defaults:{faltacursarTabLabel:"Falta Cursar",microhorarioTabLabel:"Micro Hor\u00e1rio",selectedTabLabel:"Selecionadas"}}),mainStringsModel=new MainStringsModel,MicrohorarioStringsModel=Backbone.Model.extend({defaults:{openFiltersStr:"Abrir filtros",
closeFiltersStr:"Fechar filtros",subjectCodeLabel:"C\u00f3digo da disciplina",subjectNameLabel:"Nome da disciplina",professorNameLabel:"Professor",moreFiltersStr:"Mais filtros",lessFiltersStr:"Menos filtros",toggleBlockedDisabledLabel:"Exibir disciplinas cursadas ou bloqueadas",noQueryStr:"N\u00e3o foi feita nenhuma busca",nCreditsLabel:"N\u00ba de cr\u00e9ditos",targetBlockLabel:"Bloqueio",dayLabel:"Dia da semana",timeBeginLabel:"Hor\u00e1rio de in\u00edcio",timeEndLabel:"Hor\u00e1rio de t\u00e9rmino",
noFixedScheduleLabel:"Sem hor\u00e1rio fixo",distanceHoursLabel:"Com horas \u00e0 dist\u00e2ncia",resetButtonLabel:"Limpar campos",submitButtonLabel:"Buscar",waitingImgURL:"/img/ajax-loader.gif",endOfDataMsg:"Os resultados para essa busca terminaram"}}),microhorarioStringsModel=new MicrohorarioStringsModel,SelectedStringsModel=Backbone.Model.extend({defaults:{option1Label:"1\u00aa op\u00e7\u00e3o",option2Label:"2\u00aa op\u00e7\u00e3o",option3Label:"3\u00aa op\u00e7\u00e3o",noneLabel:"N/A",qtdCreditsLabel:" cr\u00e9dito(s) na grade atual",
qtdClassesLabel:" turma(s) na grade atual"}}),selectedStringsModel=new SelectedStringsModel,TimetableStringsModel=Backbone.Model.extend({defaults:{daysLabel:"Segunda Ter\u00e7a Quarta Quinta Sexta S\u00e1bado".split(" ")}}),timetableStringsModel=new TimetableStringsModel,FaltacursarStringsModel=Backbone.Model.extend({defaults:{closeClassesDivLabel:"Fechar turmas",searchLabel:"Buscar:"}}),faltacursarStringsModel=new FaltacursarStringsModel,SubjectTableStringsModel=Backbone.Model.extend({defaults:{subjectCodeLabel:"C\u00f3digo da disciplina",
subjectNameLabel:"Nome da disciplina",termLabel:"Per\u00edodo",creditsLabel:"N\u00ba de cr\u00e9ditos",ementaHeaderLabel:"Ementa",ementaLinkLabel:"Ver ementa",ementaBaseLink:"http://www.puc-rio.br/ferramentas/ementas/ementa.aspx?cd=",ongoingStr:"Cursando",chosenSubjectStr:"Selecionada",noResultsStr:"N\u00e3o h\u00e1 resultados para essa busca",nOptativasChosenStr:"selecionada(s) desse grupo"}}),subjectTableStringsModel=new SubjectTableStringsModel,ClassesTableStringsModel=SubjectTableStringsModel.extend({defaults:{classCodeLabel:"C\u00f3digo da turma",
professorNameLabel:"Professor",scheduleLabel:"Hor\u00e1rios",daysAbbr:"Seg Ter Qua Qui Sex Sab".split(" "),emptyTableStr:"N\u00e3o h\u00e1 turmas a serem exibidas",SHF:"Sem hor\u00e1rio fixo",blockLabel:"Destinos",placesStr:"vagas"}});_.extend(ClassesTableStringsModel.prototype.defaults,SubjectTableStringsModel.prototype.defaults);
var classesTableStringsModel=new ClassesTableStringsModel,MainHelpersStringsModel=Backbone.Model.extend({defaults:{tooltipButtonLabel:"Desativar",ableSubjectRowText:"Clique na linha de uma disciplina para\t\t\tabrir suas turmas",blockedSubjectRowText:"Voc\u00ea pode visualizar as turmas dessa disciplina, \t\t\tmas o sistema nos diz que voc\u00ea n\u00e3o tem os pr\u00e9-requisitos necess\u00e1rios \t\t\tpara curs\u00e1-la. Temporariamente, adicionar uma turma dessa disciplina est\u00e1 \t\t\thabilitado devido a bugs; clique para visualizar as turmas",
warningSubjectRowText:'Uma disciplina em amarelo significa que voc\u00ea ou est\u00e1 \t\t\tcursando-a nesse per\u00edodo (aquelas marcadas com "Cursando") ou necessita ser aprovado em alguma(s) disciplina(s) \t\t\tque voc\u00ea est\u00e1 cursando. Clique para visualizar as turmas',optativaRowText:"Clique nessa optativa para abrir suas disciplinas; clique novamente para \t\t\tfech\u00e1-las",selectedSubjectRowText:"Essa disciplina est\u00e1 selecionada, o que significa que suas turmas est\u00e3o listadas \t\t\tabaixo; clique novamente para fechar as turmas",
ableClassRowText:"Clique nessa turma para selecion\u00e1-la; ela aparecer\u00e1 em uma das op\u00e7\u00f5es da aba de \t\t\tselecionadas",chosenClassRowText:"Essa turma j\u00e1 est\u00e1 selecionada, o que significa que ela est\u00e1 ocupando \t\t\talguma das posi\u00e7\u00f5es na aba de selecionadas. Clique novamente para deselecion\u00e1-la",warningClassRowText:'Da mesma forma que disciplinas em amarelo, turmas em amarelo ou est\u00e3o sendo \t\t\tcursadas (estas t\u00eam um texto "Cursando" ao lado) ou \u00e9 necess\u00e1ria a aprova\u00e7\u00e3o em alguma \t\t\tmat\u00e9ria que est\u00e1 sendo cursada para que o pedido seja aprovado',
disabledClassRowText:"Turmas em cinza s\u00e3o de disciplinas que voc\u00ea j\u00e1 cursou",blockedClassRowText:"Turmas marcadas com vermelho s\u00e3o as que voc\u00ea n\u00e3o tem os pr\u00e9-requisitos \t\t\tpara cursar. Temporariamente, devido a bugs, clique na turma para adicion\u00e1-la",timeCellText:"Clique numa c\u00e9lula de um hor\u00e1rio para buscar todas as turmas naquele hor\u00e1rio",emptyCellText:"Clique numa c\u00e9lula vazia para buscar todas as turmas naquele dia e hor\u00e1rio",
classCellText:"Clique numa turma para buscar todas as turmas da disciplina",dayCellText:"Clique numa c\u00e9lula com um dia para buscar todas as turmas daquele dia",selectedRowText:"Arraste as linhas para reorden\u00e1-las",selectedClassText:"Arraste as turmas para qualquer um dos espa\u00e7os. Se j\u00e1 tiver uma turma \t\t\tnaquele espa\u00e7o, as duas ser\u00e3o trocadas de lugar"}}),mainHelpersStringsModel=new MainHelpersStringsModel,HorariosModel=Backbone.Model.extend({get:function(a){return overriddenGet(this,
a)},printHorario:function(){var a=classesTableStringsModel.get("daysAbbr");return this.get("DiaSemana")?a[this.get("DiaSemana")-2]+" "+this.get("HoraInicial")+"-"+this.get("HoraFinal")+" ("+this.get("Unidade")+");":classesTableStringsModel.get("SHF")+" ("+this.get("Unidade")+");"}}),HorariosList=Backbone.Collection.extend({model:HorariosModel}),BlockModel=Backbone.Model.extend({get:function(a){return overriddenGet(this,a)},printBlock:function(){return this.get("Destino")+" ("+this.get("Vagas")+" "+
classesTableStringsModel.get("placesStr")+");"}}),BlocksList=Backbone.Collection.extend({model:BlockModel}),classMap={},ClassModel=Backbone.Model.extend({initialize:function(){var a=this.get("Horarios"),a=new HorariosList(a);this.set(serverDictionary.get("Horarios"),a);a=this.get("Destinos");a=new BlocksList(a);this.set(serverDictionary.get("Destino")+"s",a);classMap[this.get("PK_Turma")]=this},get:function(a){if("Destinos"==a)return a=serverDictionary.get("Destino")+"s",Backbone.Model.prototype.get.call(this,
a);var b=overriddenGet(this,a);b||(b=overriddenGet(Backbone.Model.prototype.get.call(this,"subject"),a));return b},printSchedule:function(){var a=document.createElement("div");_.each(this.get("Horarios").models,function(b){var c=document.createElement("span");c.innerHTML=b.printHorario();a.appendChild(c);a.appendChild(document.createElement("br"))});return a.innerHTML},printBlocks:function(){var a=document.createElement("div");_.each(this.get("Destinos").models,function(b){var c=document.createElement("span");
c.innerHTML=b.printBlock();a.appendChild(c);a.appendChild(document.createElement("br"))});return a.innerHTML},formatData:function(){return{subjectCode:this.get("CodigoDisciplina"),subjectName:this.get("NomeDisciplina"),professorName:this.get("NomeProfessor"),code:this.get("CodigoTurma"),schedule:this.printSchedule(),block:this.printBlocks(),subjectCode:this.get("CodigoDisciplina"),credits:this.get("Creditos"),classId:this.get("PK_Turma"),status:this.get("Situacao"),able:this.get("Apto"),chosen:selectedModel.isSelected(this.get("CodigoDisciplina"),
this.get("PK_Turma"))}}});ClassList=Backbone.Collection.extend({model:ClassModel,add:function(a,b){if(b.subject)return overriddenAdd(this,a,b,"PK_Turma",{subject:b.subject});console.log("Must provide subject for class")}});
SubjectModel=Backbone.Model.extend({initialize:function(){var a=this.get("Turmas"),b=new ClassList;b.add(a,{subject:this});this.set(serverDictionary.get("Turmas"),b)},get:function(a){return overriddenGet(this,a)},formatData:function(a){return{code:this.get("CodigoDisciplina"),name:this.get("NomeDisciplina"),credits:this.get("Creditos"),able:this.get("Apto"),status:this.get("Situacao"),ingroup:a,chosen:selectedModel.isSelected(this.get("CodigoDisciplina"))}}});
SubjectList=Backbone.Collection.extend({model:SubjectModel,add:function(a,b){return overriddenAdd(this,a,b,"CodigoDisciplina")},getClass:function(a){return classMap[a]}});
var subjectList=new SubjectList,OptativaModel=Backbone.Model.extend({get:function(a){return overriddenGet(this,a)},countChosen:function(){var a=0,b=this.get("Disciplinas"),c=serverDictionary.get("CodigoDisciplina");for(idx in b)selectedModel.isSelected(b[idx][c])&&a++;return a},formatData:function(){return{code:this.get("CodigoOptativa"),name:this.get("NomeOptativa"),term:this.get("PeriodoAno"),credits:"-",able:2,status:this.getStatus(),optativa:!0,nSubjectsChosen:this.countChosen()}},getStatus:function(){return"NC"}}),
OptativasList=Backbone.Collection.extend({model:OptativaModel,add:function(a,b){return overriddenAdd(this,a,b,"CodigoOptativa")}}),FaltacursarModel=Backbone.Model.extend({get:function(a){return overriddenGet(this,a)},set:function(a){var b=serverDictionary.get("Disciplinas");Backbone.Model.prototype.set.call(this,b,a[b]);b=serverDictionary.get("Optativas");a=new OptativasList(a[b]);Backbone.Model.prototype.set.call(this,b,a)},getTableRows:function(){var a=[];_.each(this.get("Disciplinas"),function(b){var c=
subjectList.get(b[serverDictionary.get("CodigoDisciplina")]);a.push($.extend({},c.formatData(!1),{term:b[serverDictionary.get("PeriodoAno")]}))});_.each(this.get("Optativas").models,function(b){a.push(b.formatData())});return a},getSubjectsOptativa:function(a){var b=[],c=this.get("Optativas").get(a);_.each(c.get("Disciplinas"),function(a){a=subjectList.get(a[serverDictionary.get("CodigoDisciplina")]);b.push($.extend({},a.formatData(!0),{term:c[serverDictionary.get("PeriodoAno")]}))});return b},getSubjectClasses:function(a){var a=
subjectList.get(a).get("Turmas"),b=[];_.each(a.models,function(a){b.push(a.formatData())});return b}}),faltacursarModel=new FaltacursarModel,SelectedModel=Backbone.Model.extend({options:"",viewEl:"#main-selected-div tbody",maxRows:12,nOptions:3,defaults:{addedSinceLastView:0},initialize:function(){this.options=[];for(var a=0;a<this.maxRows;a++)this.options[a]=[];for(a=0;a<this.maxRows;a++)for(var b=0;b<this.nOptions;b++)this.options[a][b]=null;this.on("change:addedSinceLastView",function(a){mainView.changeBadge(a.get("addedSinceLastView"))})},
isSelected:function(a,b){for(var c=0;c<this.maxRows;c++)for(var d=0;d<this.nOptions;d++)if(this.options[c][d]&&this.options[c][d].subjectCode==a)if(b){if(b==this.options[c][d].classId)return!0}else return!0;return!1},setFromServer:function(a){var b=this;_.each(a,function(a){var d=a[serverDictionary.get("CodigoDisciplina")],e=a[serverDictionary.get("FK_Turma")],f=a[serverDictionary.get("NoLinha")],a=a[serverDictionary.get("Opcao")];b.options[f][a]={subjectCode:d,classCode:subjectList.getClass(e).get("CodigoTurma"),
classId:e}})},postAll:function(a){for(var b=0;b<this.maxRows;b++)for(var c=0;c<this.nOptions;c++)this.options[b][c]=a[b][c];for(var a=[],d=0,b=0;b<this.maxRows;b++)for(c=0;c<this.nOptions;c++)null!=this.options[b][c]&&(a[d++]=this.formatForPost(b,c));$.ajax({type:"POST",url:"/api/selecionada",data:"json="+JSON.stringify(a),success:function(a){console.log("POST // All  // Msg: "+a)}})},formatForPost:function(a,b){return{NoLinha:a,Opcao:b,FK_Turma:this.options[a][b].classId}},swapContent:function(a,
b,c,d){var e=this.options[a][b];this.options[a][b]=this.options[c][d];this.options[c][d]=e;console.log(a+", "+b+","+c+", "+d);console.log(this.options);e=[];null!=this.options[a][b]&&e.push(this.formatForPost(a,b));null!=this.options[c][d]&&e.push(this.formatForPost(c,d));console.log(e);$.ajax({type:"POST",url:"/api/selecionada",data:"json="+JSON.stringify(e),success:function(a){console.log("POST // Swap  // Msg: "+a)}})},getData:function(){return this.options},changeViews:function(a,b,c){microhorarioClasseslistView.changeRow(a,
b,c);faltacursarClasseslistView.changeRow(a,b,c);faltacursarView.markAsSelected(a,this.isSelected(a));a=faltacursarModel.get("Optativas").models;for(idx in a)faltacursarView.changeOptativaLabel(a[idx].get("CodigoOptativa"),a[idx].countChosen());selectedView.render();selectedController.runSimulation()},removeClass:function(a,b){for(var c=0;c<this.maxRows;c++)for(var d=0;d<this.nOptions;d++)if(this.options[c][d]&&this.options[c][d].subjectCode==a&&this.options[c][d].classId==b)return this.options[c][d]=
null,subjectList.getClass(b),$.ajax({type:"DELETE",url:"/api/selecionada",data:"json="+JSON.stringify([{FK_Turma:b}]),success:function(c){console.log("DELETE // Disciplina: "+a+" // Turma: "+b+" // Msg: "+c)}}),this.changeViews(a,b,!1),!0;return!1},addClassToPosition:function(a,b,c,d){var e=subjectList.getClass(b);this.options[c][d]={subjectCode:a,classCode:e.get("CodigoTurma"),classId:b};$.ajax({type:"POST",url:"/api/selecionada",data:"json="+JSON.stringify([{FK_Turma:b,NoLinha:c,Opcao:d}]),success:function(c){console.log("POST // Disciplina: "+
a+" // Turma: "+b+" // Msg: "+c)}});this.changeViews(a,b,!0)},addClass:function(a,b){for(var c=0;c<this.maxRows;c++)for(var d=0;d<this.nOptions;d++)if(null!=this.options[c][d]&&this.options[c][d].subjectCode==a&&d!=this.nOptions-1&&null==this.options[c][d+1])return this.addClassToPosition(a,b,c,d+1),!0;for(c=0;c<this.maxRows;c++)if(null==this.options[c][0])return this.addClassToPosition(a,b,c,0),!0;for(c=0;c<this.maxRows;c++)for(d=0;d<this.nOptions;d++)if(null==this.options[c][d])return this.addClassToPosition(a,
b,c,d),!0;return!1}}),selectedModel=new SelectedModel,HelperModel=Backbone.Model.extend({defaults:{active:!0,text:"",selector:""},deactivate:function(){$(this.get("selector")).data("tooltip",!1);this.set("active",!1);$.ajax({url:"/api/aviso",type:"DELETE",data:'json=["'+this.id+'"]',dataType:"json",success:function(){}})}}),HelpersList=Backbone.Collection.extend({model:HelperModel,deactivateFromServer:function(a){for(var b in a)this.get(a[b][serverDictionary.get("CodAviso")]).set("active",!1)}}),
helpersList=new HelpersList;helpersList.add({id:"ableSubjectRow",text:mainHelpersStringsModel.get("ableSubjectRowText")});helpersList.add({id:"blockedSubjectRow",text:mainHelpersStringsModel.get("blockedSubjectRowText")});helpersList.add({id:"warningSubjectRow",text:mainHelpersStringsModel.get("warningSubjectRowText")});helpersList.add({id:"optativaRow",text:mainHelpersStringsModel.get("optativaRowText")});helpersList.add({id:"selectedSubjectRow",text:mainHelpersStringsModel.get("selectedSubjectRowText")});
helpersList.add({id:"ableClassRow",text:mainHelpersStringsModel.get("ableClassRowText")});helpersList.add({id:"chosenClassRow",text:mainHelpersStringsModel.get("chosenClassRowText")});helpersList.add({id:"warningClassRow",text:mainHelpersStringsModel.get("warningClassRowText")});helpersList.add({id:"blockedClassRow",text:mainHelpersStringsModel.get("blockedClassRowText")});helpersList.add({id:"disabledClassRow",text:mainHelpersStringsModel.get("disabledClassRowText")});
helpersList.add({id:"timeCell",text:mainHelpersStringsModel.get("timeCellText")});helpersList.add({id:"dayCell",text:mainHelpersStringsModel.get("dayCellText")});helpersList.add({id:"emptyCell",text:mainHelpersStringsModel.get("emptyCellText")});helpersList.add({id:"classCell",text:mainHelpersStringsModel.get("classCellText")});helpersList.add({id:"selectedRow",text:mainHelpersStringsModel.get("selectedRowText")});helpersList.add({id:"selectedClass",text:mainHelpersStringsModel.get("selectedClassText")});
$.fn.dataTableExt.oApi.fnAddTr=function(a,b,c){"undefined"==typeof c&&(c=!0);var d=b.getElementsByTagName("td");if(d.length!=a.aoColumns.length)alert("Warning: not adding new TR - columns and TD elements must match");else{for(var e=[],f=0;f<d.length;f++)e.push(d[f].innerHTML);d=this.oApi._fnAddData(a,e);b._DT_RowIndex=d;a.aoData[d].nTr=b;a.aiDisplay=a.aiDisplayMaster.slice();c&&this.oApi._fnReDraw(a)}};
$.fn.dataTableExt.oApi.fnAddTrAfter=function(a,b,c,d){"undefined"==typeof d&&(d=!0);var e=b.getElementsByTagName("td");if(e.length!=a.aoColumns.length)alert("Warning: not adding new TR - columns and TD elements must match");else{for(var f=[],g=0;g<e.length;g++)f.push(e[g].innerHTML);e=this.oApi._fnAddData(a,f);b._DT_RowIndex=c+1;a.aoData[e].nTr=b;b=a.aoData[e];a.aoData.splice(e,1);a.aoData.splice(c+1,0,b);for(g=c+2;g<a.aoData.length;g++)a.aoData[g].nTr._DT_RowIndex=g;a.aiDisplay=a.aiDisplayMaster.slice();
d&&this.oApi._fnReDraw(a)}};
var TimetableView=Backbone.View.extend({template:"",startH:7,endH:23,ndays:6,ttmat:"",initialize:function(){this.template=_.template($("#timetable-template").html());this.initHelpers()},bindCell:function(a){$(a).click(function(){microhorarioView.searchFor($(a).data("day"),$(a).data("initTime"),$(a).data("subjectCode"))})},bindCallbacks:function(){var a=this.$el.find("th");_.each(a,function(a,b){$(a).data({day:0==b?null:b-1+2,initTime:null})});for(var a=this.$el.find("td"),b=0,c=this.startH;c<this.endH;c++){$(a[b++]).data({day:null,
initTime:c,subjectCode:null});for(var d=2;d<this.ndays+2;d++)0!=this.ttmat[c][d].span&&(null!=this.ttmat[c][d].subjectCode?$(a[b++]).data({subjectCode:this.ttmat[c][d].subjectCode,day:null,initTime:null}):$(a[b++]).data({day:d,initTime:c,subjectCode:null}))}var a=this.$el.find("td, th"),e=this;_.each(a,function(a){e.bindCell(a)})},formatString:function(a,b,c){a=b.get("Horarios").models[a].get("Unidade");return c+" - "+b.get("CodigoTurma")+"<br/><span>"+subjectList.get(c).get("NomeDisciplina")+"</span><br/><span>("+
a+")</span>"},processArray:function(a){for(var b=[],c=this.startH;c<this.endH;c++){b[c]=[];for(var d=2;d<this.ndays+2;d++)b[c][d]={string:"",span:1,customClass:null,subjectCode:null}}for(c=0;c<a.length;c++)for(var d=subjectList.getClass(a[c].classId),e=d.get("Horarios").models,f=0;f<e.length;f++){var g=e[f].get("DiaSemana"),h=e[f].get("HoraInicial"),i=e[f].get("HoraFinal");if(g){b[h][g].string=this.formatString(f,d,a[c].subjectCode);b[h][g].span=Number(i)-Number(h);b[h][g].customClass="ttclass"+a[c].cssClass;
b[h][g].subjectCode=a[c].subjectCode;for(h+=1;h<i;h++)b[h][g].span=0}}return b},buildTableBody:function(a){void 0==a&&(a=[]);this.ttmat=this.processArray(a);for(var a=document.createElement("tbody"),b=this.startH;b<this.endH;b++){var c=document.createElement("tr"),d=document.createElement("td");$(d).addClass("text-top");$(d).addClass("timeCell");$(d).html(b+":00");$(c).append(d);for(d=2;d<this.ndays+2;d++)if(0!=this.ttmat[b][d].span){var e=document.createElement("td"),f=document.createElement("div");
f.innerHTML=this.ttmat[b][d].string;""==this.ttmat[b][d].string?$(e).addClass("emptyCell"):$(e).addClass("classCell");this.ttmat[b][d].customClass&&$(e).addClass(this.ttmat[b][d].customClass);e.rowSpan=this.ttmat[b][d].span;e.appendChild(f);c.appendChild(e)}$(a).append(c)}return $(a).html()},initHelpers:function(){helpersList.get("emptyCell").set("selector","#main-timetable-div td.emptyCell");helpersList.get("dayCell").set("selector","#main-timetable-div th.dayCell");helpersList.get("classCell").set("selector",
"#main-timetable-div td.classCell");helpersList.get("timeCell").set("selector","#main-timetable-div td.timeCell")},bindHelpers:function(){helperView.create("emptyCell");helperView.create("dayCell");helperView.create("timeCell");helperView.create("classCell")},render:function(a){this.$el.html(this.template({timetableStr:timetableStringsModel}));this.$el.find("tbody").html(this.buildTableBody(a));this.bindCallbacks();this.bindHelpers();mainView.equalMainDivsHeight()}}),timetableView=new TimetableView,
FaltacursarView=Backbone.View.extend({template:"",templateRow:"",subjectDatatableView:"",closedImg:"Setinha Mini copy.PNG",openImg:"Setinha Mini.PNG",defaultImgPath:"img/",subjectTableWrapper:"",classesDiv:"",subjectTable:"",subjectDatatable:"",subjectTableFilter:"",subjectTableHeader:"",subjectTableBody:"",initialize:function(){this.template=_.template($("#faltacursar-template").html());this.templateRow=_.template($("#faltacursar-row-template").html());var a=this;$(window).resize(function(){a.resize()})},
cache:function(){this.subjectTableWrapper=$("#faltacursar-subject-table_wrapper");this.classesDiv=$("#faltacursar-classes-div");this.subjectTable=$("#faltacursar-subject-table");this.subjectTableFilter=$("#faltacursar-subject-table_wrapper\t\t\t\t\t .dataTables_filter");this.subjectTableHeader=$("#faltacursar-subject-table_wrapper\t\t\t\t\t .dataTables_scrollHead");this.subjectTableBody=$("#faltacursar-subject-table_wrapper\t\t\t\t\t .dataTables_scrollBody")},events:{"click #faltacursar-subject-table tr":"clickOnRow",
"click #faltacursar-subject-table .ementaButton":"clickOnEmenta","click #close-classes-button":"clickOnCloseClasses"},handleOptativa:function(a){var b=$(a).attr("id"),b=faltacursarModel.getSubjectsOptativa(b),c=this.subjectDatatable.fnGetPosition($(a)[0]);if($(a).hasClass("openOptativa")){$(a).removeClass("openOptativa");$(a).find("td.imgCell img").attr("src",this.defaultImgPath+this.closedImg);for(var d=$(a),e=0;e<b.length;e++)$(d).next().hasClass("subjectSelected")&&this.closeClassesDiv(),this.subjectDatatable.fnDeleteRow(c+
1,null,!1),d=$(d).next();this.subjectDatatable.fnDraw()}else $(a).addClass("openOptativa"),$(a).find("td.imgCell img").attr("src",this.defaultImgPath+this.openImg),b.reverse(),this.addRowsToTable(b,c),$(a).next().addClass("extraBorder");this.calculateScrollTop(a)},clickOnCloseClasses:function(){$(this.subjectTable).find("tr.subjectSelected").removeClass("subjectSelected");this.closeClassesDiv()},changeOptativaLabel:function(a,b){var c=$("#"+a).find(".selected-label");$(c).html(b+" "+subjectTableStringsModel.get("nOptativasChosenStr"));
b?$(c).removeClass("hidden"):$(c).addClass("hidden")},markAsSelected:function(a,b){row=$("#"+a);b?$(row).find(".name .selected-label").removeClass("hidden"):$(row).find(".name .selected-label").addClass("hidden")},closeClassesDiv:function(){$(this.subjectTableWrapper).addClass("whole").removeClass("half");this.calculateTableScroll();$(this.classesDiv).addClass("hidden")},clickOnRow:function(a){a=$(a.target).parents("tr");if($(a).hasClass("optativa"))return this.handleOptativa(a);$(a.find("td").first()).hasClass("dataTables_empty")||
($(a).hasClass("subjectSelected")?($(a).removeClass("subjectSelected"),this.closeClassesDiv()):($(this.subjectTable).find("tr.subjectSelected").removeClass("subjectSelected"),$(a).addClass("subjectSelected"),$(this.subjectTableWrapper).addClass("half").removeClass("whole"),this.calculateTableScroll(),$(this.classesDiv).removeClass("hidden"),$(this.classesDiv).addClass("almostHalf"),a=$(a).attr("id"),a=faltacursarModel.getSubjectClasses(a).sort(function(a,c){return a.code>c.code?1:a.code<c.code?-1:
0}),faltacursarClasseslistView.render(a),faltacursarClasseslistView.resize()))},clickOnEmenta:function(a){a.stopPropagation()},resize:function(){this.subjectDatatable||(this.subjectDatatable=$("#faltacursar-subject-table").dataTable());this.subjectDatatable.fnAdjustColumnSizing(!1);this.calculateTableScroll()},calculateScrollTop:function(a){var a=this.subjectDatatable.fnGetPosition($(a)[0]),b=0;$(this.subjectTableBody).find("tr").slice(0,a+1).each(function(){b+=$(this).height()});$(this.subjectTableBody).scrollTop(b)},
calculateTableScroll:function(){var a=$(this.subjectTableWrapper).height(),b=$(this.subjectTableFilter).outerHeight(!0)+$(this.subjectTableHeader).outerHeight(!0),c=$(this.subjectTableBody).outerHeight(!0)-$(this.subjectTableBody).height();$(this.subjectTableBody).height(a-b-c)},initHelpers:function(){helpersList.get("ableSubjectRow").set("selector","#faltacursar-subject-table tr:not(.optativa,.subjectWarning, \t\t\t.subjectBlocked, .subjectSelected)");helpersList.get("optativaRow").set("selector",
"#faltacursar-subject-table tr.optativa");helpersList.get("blockedSubjectRow").set("selector","#faltacursar-subject-table tr.subjectBlocked:not(.subjectSelected)");helpersList.get("warningSubjectRow").set("selector","#faltacursar-subject-table tr.subjectWarning:not(.subjectSelected)")},bindHelpers:function(){helperView.create("ableSubjectRow");helperView.create("optativaRow");helperView.create("warningSubjectRow");helperView.create("blockedSubjectRow")},initJS:function(){var a=this;this.subjectDatatable=
$("#faltacursar-subject-table").dataTable({sDom:"ft",bPaginate:!1,bScrollCollapse:!0,sScrollY:"200px",bSort:!1,oLanguage:{sZeroRecords:subjectTableStringsModel.get("noResultsStr"),sSearch:faltacursarStringsModel.get("searchLabel")},fnDrawCallback:function(){a.calculateTableScroll()}});$("#faltacursar-subject-table_wrapper").addClass("whole");this.initHelpers()},addRowsToTable:function(a,b){for(idx in a){var c=this.templateRow({subject:a[idx],subjectTableStr:subjectTableStringsModel});void 0==b?this.subjectDatatable.fnAddTr($(c)[0],
!1):this.subjectDatatable.fnAddTrAfter($(c)[0],b,!1)}this.subjectDatatable.fnAdjustColumnSizing(!0);this.bindHelpers()},render:function(){var a=faltacursarModel.getTableRows().sort(function(a,c){return a.term!=c.term?a.term-c.term:a.code-c.code});this.$el.html(this.template({subjectTableStr:subjectTableStringsModel,faltacursarStr:faltacursarStringsModel}));this.initJS();this.cache();this.addRowsToTable(a);faltacursarClasseslistView.setElement("#faltacursar-classes-table-div");this.subjectDatatable.fnAdjustColumnSizing(!1);
this.calculateTableScroll()}}),faltacursarView=new FaltacursarView,MicrohorarioView=Backbone.View.extend({template:"",waitingTemplate:"",noQueryTemplate:"",resultsDiv:"",noQueryState:"noQuery",queryState:"query",waitingState:"waiting",events:{"click #more-filters-button":"moreFilters","click #less-filters-button":"lessFilters","click #open-filters-button":"openFilters","click #close-filters-button":"closeFilters","submit #microhorario-form":"query","reset #microhorario-form":"clear"},moreFilters:function(){$("#hidden-filters").removeClass("hidden");
$("#less-filters-button").removeClass("hidden");$("#more-filters-button").addClass("hidden");microhorarioClasseslistView.resize()},lessFilters:function(){$("#hidden-filters").addClass("hidden");$("#less-filters-button").addClass("hidden");$("#more-filters-button").removeClass("hidden");microhorarioClasseslistView.resize()},openFilters:function(){$("#microhorario-filter").removeClass("hidden");$("#open-filters-button").addClass("hidden");$("#close-filters-button").removeClass("hidden");microhorarioClasseslistView.resize()},
closeFilters:function(){$("#microhorario-filter").addClass("hidden");$("#open-filters-button").removeClass("hidden");$("#close-filters-button").addClass("hidden");microhorarioClasseslistView.resize()},searchFor:function(a,b,c){this.clear();null==a&&(a="");null==b&&(b="");null==c&&(c="");$('input[name="HoraInicial"]').attr("value",b);$('select[name="DiaSemana"]').find('option[value="'+a+'"]').attr("selected",!0);$('input[name="CodigoDisciplina"]').attr("value",c);mainRouter.navigate("microhorario",
{trigger:!0});this.openFilters();this.query()},query:function(){this.changeState(this.waitingState);microhorarioController.fetchData(!0);return!1},clear:function(){$('input[type="text"]').attr("value","");$('select[name="DiaSemana"]').find("option").attr("selected",!1);$('select[name="DiaSemana"]').find('option[value=""]').attr("selected",!0);$('input[type="checked"]').attr("checked",!1);this.changeState(this.noQueryState)},setFiltersState:function(){0!=$("#hiddenFilters").find('input:checked, input[type="text"][value!=""],\t\t\t\toption[value!=""]:selected').length?
this.moreFilters():this.lessFilters()},initialize:function(){this.template=_.template($("#microhorario-template").html());this.waitingTemplate=_.template($("#microhorario-waiting-template").html());this.noQueryTemplate=_.template($("#microhorario-noquery-template").html())},changeState:function(a,b){void 0==typeof b&&(b=[]);a==this.queryState?(this.setFiltersState(),microhorarioClasseslistView.render(b)):a==this.noQueryState?this.$resultsDiv.html(this.noQueryTemplate({str:microhorarioStringsModel})):
this.$resultsDiv.html(this.waitingTemplate({str:microhorarioStringsModel}))},resize:function(){microhorarioClasseslistView.resize()},bindValidators:function(){$('input[name="Creditos"]').change(function(a){microhorarioValidator.intMask(a.target,3)});$('input[name="HoraInicial"]').change(function(a){microhorarioValidator.hourMask(a.target)});$('input[name="HoraFinal"]').change(function(a){microhorarioValidator.hourMask(a.target)})},render:function(){this.$el.html(this.template({str:microhorarioStringsModel,
timetableStr:timetableStringsModel}));this.$resultsDiv=$("#microhorario-results");microhorarioClasseslistView.setElement(this.$resultsDiv);this.bindValidators();this.changeState(this.noQueryState)}}),microhorarioView=new MicrohorarioView,SelectedView=Backbone.View.extend({templateRow:"",template:"",templateDraggable:"",initialize:function(){this.templateRow=_.template($("#selected-row-template").html());this.template=_.template($("#selected-template").html());this.templateDraggable=_.template($("#selected-draggable-template").html());
this.initHelpers()},initHelpers:function(){helpersList.get("selectedRow").set("selector","#main-selected-div tr");helpersList.get("selectedClass").set("selector","#main-selected-div td:has(div):not(.radio)");$(helpersList.get("selectedClass").get("selector")).live("mouseover",function(a){a.stopPropagation()})},changeInfo:function(a,b){var c=$("#info-container");c.find("#qtd-credits").html(a+" "+selectedStringsModel.get("qtdCreditsLabel"));c.find("#qtd-classes").html(b+" "+selectedStringsModel.get("qtdClassesLabel"))},
events:{"click button.close":"deleteClass",'change input[type="radio"]':"radioChange"},radioChange:function(a){a=$(a.target).parent();a=$(a).parent();a=$("#main-selected-div tbody tr").index(a);selectedController.runSimulation(a)},resize:function(){this.calculateHeightDivs()},equalDroppables:function(){var a=this.$el.find("tbody tr").first(),b=a.width(),c=0,a=a.find("td.class-droppable").each(function(){c+=$(this).width()}),b=Math.ceil(100*c/(3*b));a.css("width",b+"%")},deleteClass:function(a){var b=
$(a.target).parent("div"),a=$(b).find('input[type="hidden"][name="subjectCode"]').attr("value"),b=$(b).find('input[type="hidden"][name="classCode"]').attr("value");selectedModel.removeClass(a,b);this.equalDroppables()},buildRow:function(a,b){for(var c=[],d=0;d<b.length;d++)b[d]&&(c[d]=this.templateDraggable(b[d]));return this.templateRow({index:a,options:b,template:c})},buildSelected:function(a){this.$el.html(this.template({selectedStr:selectedStringsModel}));for(var b=this.$el.find("tbody"),c=0;c<
a.length;c++)$(b).append(this.buildRow(c,a[c]));for(c=a.length;c<selectedModel.maxRows;c++)$(b).append(this.buildRow(c,[]))},calculateHeightDivs:function(){$("#table-container").height($("#main-selected-div").height()-$("#info-container").outerHeight(!0))},render:function(){this.buildSelected(selectedModel.getData());this.initJS()},sortableInit:function(){var a=this;this.$el.find("tbody.selected-sortable").sortable({helper:function(a,c){var d=c.children(),e=c.clone();e.children().each(function(a){$(this).width(d.eq(a).width());
$(this).height(d.eq(a).height())});return e},start:function(){var b={};a.$el.find('input[type="radio"]',this).each(function(){$(this).is(":checked")&&(b[$(this).attr("name")]=$(this).val());$(document).data("radio_checked",b)})}}).bind("sortstop",function(){var a=$(document).data("radio_checked");$.each(a,function(a,b){$('input[name="'+a+'"][value="'+b+'"]').prop("checked",!0)});selectedController.sortLines();selectedController.runSimulation()})},draggableInit:function(){this.$el.find("div.class-draggable").draggable({revert:"invalid",
zIndex:1E3})},droppableInit:function(){this.$el.find("td.class-droppable").droppable({drop:function(a,b){selectedController.swapPlaces($(this),$(b.draggable).parent());$(this).has("div.class-draggable")&&$(b.draggable).parent().append($(this).find("div.class-draggable"));$(b.draggable).css({left:"0px",right:"0px",top:"0px",bottom:"0px"});$(this).append($(b.draggable));selectedController.runSimulation()},accept:".class-draggable"})},bindHelpers:function(){helperView.create("selectedRow");helperView.create("selectedClass")},
initJS:function(){this.sortableInit();this.draggableInit();this.droppableInit();this.bindHelpers()}}),selectedView=new SelectedView,HelperView=Backbone.Model.extend({el:"body",curr:null,formatTooltip:function(a){return"<span>"+helpersList.get(a).get("text")+'</span><br/>\t\t\t<button id="'+a+'tooltip" class="btn btn-primary btn-small">'+mainHelpersStringsModel.get("tooltipButtonLabel")+"</button>"},create:function(a){var b=helpersList.get(a);b.get("active")&&$(b.get("selector")).qtip({content:{text:this.formatTooltip(a)},
position:{my:"top center",at:"bottom center",viewport:$(window)},style:{classes:"qtip-bootstrap qtip-blue"},show:{solo:!0},hide:{delay:"800"},events:{show:function(a){a.stopPropagation()}}})}}),helperView=new HelperView,MainView=Backbone.View.extend({el:"",template:"",rendered:!1,tabs:{faltacursar:{li:"main-faltacursar-li",div:"main-faltacursar-div",href:"#faltacursar",view:faltacursarView},microhorario:{li:"main-microhorario-li",div:"main-microhorario-div",href:"#microhorario",view:microhorarioView},
selected:{li:"main-selected-li",div:"main-selected-div",href:"#selected",view:selectedView}},defaultTab:"faltacursar",timetableDiv:"",sidebarDiv:"",tabsNav:"",initialize:function(){this.template=_.template($("#main-template").html());var a=this;$(window).resize(function(){a.equalMainDivsHeight()})},cache:function(){this.timetableDiv=document.getElementById("main-timetable-div");this.sidebarDiv=document.getElementById("main-sidebar-div");this.tabsNav=document.getElementById("main-tabs-nav")},equalMainDivsHeight:function(){var a=
$(this.timetableDiv).height()-1;$(this.sidebarDiv).height(a);a-=$(this.tabsNav).outerHeight(!0);faltacursarView.$el.height(a);microhorarioView.$el.height(a);selectedView.$el.height(a)},setActiveTab:function(a){$("#main-tabs-nav li").removeClass("active");$("#main-tab-panes div").removeClass("active");$("#"+this.tabs[a].li).addClass("active");$("#"+this.tabs[a].div).addClass("active");this.tabs[a].view.resize();"selected"==a&&selectedModel.set("addedSinceLastView",0)},changeBadge:function(a){a?($("#selected-badge").html(a),
$("#selected-badge").removeClass("hidden")):$("#selected-badge").addClass("hidden")},renderSubviews:function(){timetableView.setElement("#main-timetable-div");timetableView.render();faltacursarView.setElement("#main-faltacursar-div");faltacursarView.render();microhorarioView.setElement("#main-microhorario-div");microhorarioView.render();selectedView.setElement("#main-selected-div");selectedView.render()},render:function(){this.$el.html(this.template({tabs:this.tabs,mainStr:mainStringsModel}));this.renderSubviews();
this.rendered=!0;this.cache()}}),mainView=new MainView,ClasseslistView=Backbone.View.extend({templateTable:"",templateRow:"",el:"",subjectInfo:"",classesDatatable:null,classesTableHead:"",classesTableBody:"",events:{"click .dataTables_scrollBody tr":"clickOnClass"},clickOnClass:function(a){a=$(a.target).parents("tr");if(!$(a).hasClass("subjectDisabled")&&!$(a.find("td").first()).hasClass("dataTables_empty")){var b=$(a).find('input[type="hidden"][name="subjectCode"]').attr("value"),c=$(a).find('input[type="hidden"][name="classId"]').attr("value");
$(a).hasClass("classChosen")?($(a).removeClass("classChosen"),selectedModel.removeClass(b,c),0<selectedModel.get("addedSinceLastView")&&selectedModel.set("addedSinceLastView",selectedModel.get("addedSinceLastView")-1)):($(a).addClass("classChosen"),selectedModel.addClass(b,c),selectedModel.set("addedSinceLastView",selectedModel.get("addedSinceLastView")+1))}},changeRow:function(a,b,c){this.$el.find("tr").each(function(){var d=$(this).find('input[type="hidden"][name="subjectCode"]').attr("value"),
e=$(this).find('input[type="hidden"][name="classId"]').attr("value");d==a&&e==b&&(c?$(this).addClass("classChosen"):$(this).removeClass("classChosen"))})},cache:function(){this.classesTableHead=this.$(".dataTables_scrollHead");this.classesTableBody=this.$(".dataTables_scrollBody")},resize:function(){this.classesDatatable&&this.classesDatatable.fnDraw(!1)},calculateTableScroll:function(){},initialize:function(){this.templateTable=_.template($("#classeslist-template").html());this.templateRow=_.template($("#classeslist-row-template").html())},
initHelpers:function(){helpersList.get("ableClassRow").set("selector",".dataTables_scrollBody tr:not(.subjectDisabled, .classChosen, \t\t\t.subjectBlocked, .subjectWarning)");helpersList.get("chosenClassRow").set("selector",".dataTables_scrollBody tr.classChosen");helpersList.get("warningClassRow").set("selector",".dataTables_scrollBody tr.subjectWarning:not(.classChosen)");helpersList.get("blockedClassRow").set("selector",".dataTables_scrollBody tr.subjectBlocked:not(.classChosen)");helpersList.get("disabledClassRow").set("selector",
".dataTables_scrollBody tr.subjectDisabled")},initJS:function(){var a=this;this.classesDatatable=this.$el.find("table").dataTable({sDom:this.options.sDom,bPaginate:!1,bScrollCollapse:!0,sScrollY:"20000px",bSort:!1,oLanguage:{sEmptyTable:classesTableStringsModel.get("emptyTableStr"),sSearch:faltacursarStringsModel.get("searchLabel")},fnDrawCallback:function(){a.calculateTableScroll()}});this.initHelpers()},bindHelpers:function(){helperView.create("ableClassRow");helperView.create("chosenClassRow");
helperView.create("warningClassRow");helperView.create("blockedClassRow");helperView.create("disabledClassRow")},addRowsToTable:function(a){for(idx in a){var b=this.templateRow({classO:a[idx],classesTableStr:classesTableStringsModel,subjectInfo:this.subjectInfo});this.classesDatatable.fnAddTr($(b)[0],!1)}this.classesDatatable.fnAdjustColumnSizing(!0);this.bindHelpers()},render:function(a){this.$el.html(this.templateTable({classesTableStr:classesTableStringsModel,subjectInfo:this.subjectInfo}));this.initJS();
this.cache();this.addRowsToTable(a);this.calculateTableScroll()}}),MicrohorarioClasseslistView=ClasseslistView.extend({subjectInfo:!0,waitingData:!1,waitingTemplate:"",alertTemplate:"",endOfDataMsg:!1,initialize:function(){this.templateTable=_.template($("#classeslist-template").html());this.templateRow=_.template($("#classeslist-row-template").html());this.waitingTemplate=_.template($("#microhorario-waiting-template").html());this.alertTemplate=_.template($("#microhorario-end-of-data-template").html())},
events:{"click .dataTables_scrollBody tr":"clickOnClass","click .dataTables_scrollBody tr .ementaButton":"clickOnEmenta"},clickOnEmenta:function(a){a.stopPropagation()},addNextPage:function(a,b){$(this.classesTableBody).find("div").remove();if(a)$(this.classesTableBody).append(this.alertTemplate({str:microhorarioStringsModel})),this.endOfDataMsg=!0;else{var c=$(this.classesTableBody).scrollTop();this.addRowsToTable(b);$(this.classesTableBody).scrollTop(c)}this.waitingData=!1},bindEndOfScroll:function(){var a=
this;this.$el.find(".dataTables_scrollBody").scroll(function(){if($(this).scrollTop()&&$(this).scrollTop()+$(this).innerHeight()==$(this)[0].scrollHeight&&!a.waitingData){a.waitingData=!0;var b=document.createElement("div");$(b).html(a.waitingTemplate({str:microhorarioStringsModel}));$(a.classesTableBody).append(b);microhorarioController.fetchData(!1)}})},calculateTableScroll:function(){var a=0;$("#microhorario-filter").hasClass("hidden")||(a+=$("#microhorario-filter").outerHeight(!0));var a=a+$("#microhorario-togglefilter").outerHeight(!0),
b=$(this.el).outerHeight(!0)-$(this.el).height(),a=$(this.el).parent().height()-a-b;$(this.el).height(a);b=$(this.classesTableHead).outerHeight();$(this.classesTableBody).height(a-b);this.bindEndOfScroll()}}),microhorarioClasseslistView=new MicrohorarioClasseslistView({sDom:"t"}),FaltacursarClasseslistView=ClasseslistView.extend({subjectInfo:!1,calculateTableScroll:function(){var a=this.$el.parent().height(),b=this.$el.parent().find("#close-classes-div").outerHeight(!0),c=this.$el.find(".dataTables_filter").outerHeight(!0)+
$(this.classesTableHead).outerHeight(!0),d=$(this.classesTableBody).outerHeight(!0)-$(this.classesTableBody).height(),a=a-c-b-d;a<$(this.classesTableBody).height()&&$(this.classesTableBody).height(a)}}),faltacursarClasseslistView=new FaltacursarClasseslistView({sDom:"ft"});
function MicrohorarioController(){var a;this.end=!1;this.nextPage=0;var b=this;this.fetchData=function(c){c&&(a=$("#microhorario-form").serialize(),b.nextPage=0,b.end=!1);if(b.end)return microhorarioClasseslistView.addNextPage(b.end);$.ajax({url:"/api/microhorario",type:"GET",data:a+"&Pagina="+b.nextPage+"&Quantidade=10",dataType:"json",success:function(a){c?b.buildTable(a):b.addRows(a);b.nextPage++}})};var c=function(a){subjectList.add(a[serverDictionary.get("Dependencia")]);var b=[];_.each(a[serverDictionary.get("MicroHorario")],
function(a){a=subjectList.getClass(a[serverDictionary.get("PK_Turma")]);b.push(a.formatData())});return b};this.buildTable=function(a){a=c(a);microhorarioView.changeState(microhorarioView.queryState,a)};this.addRows=function(a){a=c(a);0==a.length&&(b.end=!0);microhorarioClasseslistView.addNextPage(b.end,a)}}var microhorarioController=new MicrohorarioController;
function MicrohorarioValidator(){var a=this;this.getInt=function(a,c){for(var d="",e=0;e<a.length&&(isNaN(a[e])||!(d+=a[e],0<c&&d.length==c));e++);return d};this.intMask=function(b,c){b.value=a.getInt(b.value,c)};this.hourMask=function(b){for(var c=b.value,d=-1,e=0;e<c.length;e++)if(":"==c[e]){d=e;break}0<=d&&(c=c.substr(0,d));b.value=a.getInt(c,2)}}var microhorarioValidator=new MicrohorarioValidator;
function SelectedController(){this.runSimulation=function(a){var b=[];if(void 0==a||0>a)a=-1;var c=$("#main-selected-div tbody tr"),d=0,e=0;_.each(c,function(c){for(d>a&&$(c).find('input[type="radio"]').first().attr("checked",!0);"none"!=$(c).find('input[type="radio"]:checked').attr("value");){var g=$(c).find('input[type="radio"]:checked').parent("td").next();if(0!=$(g).find("div").length){var h=$(g).find('input[type="hidden"][name="classCode"]').attr("value"),i=$(g).find('input[type="hidden"][name="subjectCode"]').attr("value"),
k=subjectList.get(i).get("Turmas").get(h),u=subjectList.get(i).get("Creditos"),v=!0,q;for(q in b){k.get("Horarios");var m=subjectList.getClass(b[q].classId),j;if(!(j=i==b[q].subjectCode)){j=m;m=k.get("Horarios").models;j=j.get("Horarios").models;var r=!0,w=void 0;for(w in m){var n=m[w];if(n.get("DiaSemana")){for(var x in j){var l=j[x];if(l.get("DiaSemana")&&n.get("DiaSemana")==l.get("DiaSemana")){var s,p,t;s=n.get("HoraInicial");p=l.get("HoraInicial");t=n.get("HoraFinal");l=l.get("HoraFinal");s>p&&
(p=s,t=l);if(t>p){r=!1;break}}}if(!r)break}}j=!r}if(j){v=!1;break}}if(v&&30>=e+u){g="";for(k=0;k<selectedModel.maxRows;k++)if($(c).hasClass("row"+k)){g=k;break}e+=u;b.push({classId:h,subjectCode:i,cssClass:g});break}}$(g).next().find('input[type="radio"]').attr("checked",!0)}d++});timetableView.render(b);selectedView.changeInfo(e,b.length)};this.sortLines=function(){for(var a=[],b=0;b<selectedModel.maxRows;b++)a[b]=[];var c=$("#main-selected-div tbody tr"),b=0;_.each(c,function(c){var c=$(c).find(".class-droppable"),
e=0;_.each(c,function(c){var d=a[b],h=e,i;0==$(c).find("div").length?i=null:(i=$(c).find('input[type="hidden"][name="classCode"]').attr("value"),c=$(c).find('input[type="hidden"][name="subjectCode"]').attr("value"),i={subjectCode:c,classId:i,classCode:subjectList.get(c).get("Turmas").get(i).get("CodigoTurma")});d[h]=i;e++});b++});selectedModel.postAll(a)};this.swapPlaces=function(a,b){var c,d,e,f;d=$("#main-selected-div tbody tr");c=$(d).index($(a).parent());d=$(d).index($(b).parent());e=$($(a).parent().children(".class-droppable")).index(a);
f=$($(b).parent().children(".class-droppable")).index(b);selectedModel.swapContent(c,e,d,f)}}
var selectedController=new SelectedController,MainRouter=Backbone.Router.extend({routes:{"":"main",":tab":"tabs"},loadPage:function(){serverDictionary.set(DATA_VIEW.Dicionario);layoutStringsModel.set("userName",DATA_VIEW.Data[serverDictionary.get("Usuario")][serverDictionary.get("NomeAluno")]);subjectList.add(DATA_VIEW.Data[serverDictionary.get("Dependencia")]);faltacursarModel.set(DATA_VIEW.Data[serverDictionary.get("FaltaCursar")]);selectedModel.setFromServer(DATA_VIEW.Data[serverDictionary.get("Selecionadas")]);
layoutView.contentView=mainView;layoutView.loggedIn=!0;layoutView.render();mainView.render();selectedController.runSimulation()}}),mainRouter=new MainRouter;mainRouter.on("route:main",function(){this.loadPage();mainRouter.navigate(mainView.defaultTab,{trigger:!0})});mainRouter.on("route:tabs",function(a){if(!mainView.tabs[a])return mainRouter.navigate(mainView.defaultTab,{trigger:!0,replace:!0});mainView.rendered||this.loadPage();mainView.setActiveTab(a)});Backbone.history.start();
