var LayoutStringsModel = Backbone.Model.extend({
	defaults: {
		'hiStr': 'Olá',
		'loginStr': 'Login',
		'logoutStr': 'Logout',
		'commentsStr': 'Sugestões',
		'FAQStr': 'FAQ',
		'tutorialStr': 'Vídeo-tutorial',
		'codTutorialYoutube': 'XHF8WOJ6xI0',
		'projectNameStr': 'PrISMA',
		'userName': 'Bobteco da Silva',
		'footerText': 'Esse projeto é uma colaboração dos alunos\
			Julio Ribeiro, Luiza Silva, Gabriel Martinelli,\
			André Marçal, Denis Neves, Glauber Borges e\
			Maurício Fragale com o professor Sérgio Lifschitz. \
			Contato: prisma@inf.puc-rio.br'
	}
});

var layoutStringsModel = new LayoutStringsModel();
var FAQStringsModel = Backbone.Model.extend({
	defaults: {
		'dialogTitle': 'FAQ',
		'answerStr': 'Resposta:',
		'questionStr': 'Pergunta:',
		'questionList': [
			{
				'question': 'Não consigo logar no sistema.',
				'answer': 'Verifique se suas credenciais do PUC Online estão corretas. Caso positivo, verifique se seu navegador está configurado para aceitar COOKIES.'
			},
			{
				'question': 'O que significa cada cor na tabela de falta-cursar?',
				'answer': 'Vermelho: disciplina presa por algum pré-requisito;\nAmarelo: disciplina que você está cursando ou que está presa por algum pré-requisito que você está cursando;\nBranco: você está "apto" a cursar. Sugerimos verificar ementa no site da PUC para comprovar aptidão.\nAzul: disciplina selecionada. Suas turmas estão sendo exibidas;'
			},
			{
				'question': 'Como adiciono turma?',
				'answer': 'Basta clicar na turma em questão.'
			},
			{
				'question': 'Como removo turma?',
				'answer': 'Clique nela novamente. :-)\nOu então a visualize na aba de selecionadas e clique no botão "x".'
			},
			{
				'question': 'Como sei que a turma foi inserida?',
				'answer': 'É apresentada uma notificação na aba de selecionadas.'
			},
			{
				'question': 'Como adiciono as turmas do micro-horario?',
				'answer': 'Basta clicar na turma em questão.'
			},
			{
				'question': 'O que fazer na tela de selecionada?',
				'answer': 'Você pode fazer o que quiser, basicamente. Tanto trocar as turmas de posição movendo-as para um lugar vazio, quanto trocando-as de lugar com alguma outra. Assim como também é possível trocar as linhas de ordem.'
			},
			{
				'question': 'Mas por que isso é importante?',
				'answer': 'Porque o PUC Online funciona assim. Ao fazer o processamento das disciplinas, as disciplinas mais prioritárias serão aquelas que estão nas primeiras linhas e primeiras opções. Desta maneira, você pode trocar a prioridade de todas as turmas escolhidas simplesmente arrastando elas para onde você quiser.'
			},
			{
				'question': 'Ok, mas e daí?',
				'answer': 'Daí que você pode usar a magica funcionalidade dos radio buttons, apresentados logo do lado esquerdo de cada lugar que pode receber uma turma. Esses radio buttons representam a turma que foi possível de pegar na simulação.'
			},
			{
				'question': 'Simulação? Como funciona?',
				'answer': 'Tem por objetivo simular o que pode acontecer com a sua solicitação de matrícula no PUC Online.\nTendo conhecimento da priorização das primeiras linhas e primeiras opções, a simulação tenta sempre pegar as turmas nesse sentido do processamento. Isto é, você pode simular as opções que serão pegas em cada linha. Automaticamente será realizada uma cascata nas linhas menos prioritárias de forma a mostrar o que realmente aconteceria caso aquela opção fosse pega.'
			},
			{
				'question': 'Legal. Montei minha grade, e agora?',
				'answer': 'Infelizmente sua grade está salva em nosso sistema, mas não no PUC Online. Você deve entrar com os dados que foram gerados aqui no sistema de requisição de matrícula acadêmica, que fica localizado dentro do PUC Online.'
			},
			{
				'question': 'O sistema apresenta erros / não funciona no meu navegador.',
				'answer': 'Infelizmente o sistema foi desenvolvido tirando proveito de recursos não suportados por browsers muito antigos. Recomendo a utilização da versão mais recente do seu browser favorito. Não esqueça de nos notificar o bug para que possamos tentar consertá-lo; utilize o campo de sugestões para tal\n\Obs: o site pode estar não completamente funcional no Internet Explorer. Recomendamos o uso de algum outro navegador popular disponível atualmente. Aqueles que recomendamos são: Google Chrome, Mozilla Firefox, Opera.'
			}
		]
	}
});

var faqStringsModel = new FAQStringsModel();
LayoutView = Backbone.View.extend({
	el: 'body',
	template: '',
	contentView: null,
	loggedIn: false,
	dialogDiv: '#dialogDiv',

	events: {
		'click #open-suggestions-link': 'openSuggestionDialog',
		'click #open-faq-link': 'openFAQDialog',
		'click #open-tutorial-link': 'openTutorialDialog',
		'click ul div.dropdown-menu': 'preventClose'
	},

	openSuggestionDialog: function() {
		suggestionsView.render();
		$(this.dialogDiv).modal('show');
	},

	openFAQDialog: function() {
		faqView.render();
		$(this.dialogDiv).modal('show');
	},

	openTutorialDialog: function() {
		tutorialView.render();
		$(this.dialogDiv).modal('show');
	},

	preventClose: function(e) {
		e.stopPropagation();
	},

	initialize: function() {
		this.template = _.template($('#layout-template').html());
	},

	initJS: function() {
		$('.dropdown-toggle').dropdown();
	},

	setView: function(view) {
		this.contentView=view;
	},

	prepareDialogs: function() {
		if (this.loggedIn) {
			suggestionsView.setElement(this.dialogDiv);
		}
		
		faqView.setElement(this.dialogDiv);
		tutorialView.setElement(this.dialogDiv);
	},
	
	render: function() {
		var args = {
			layoutStr: layoutStringsModel,
			loggedIn: this.loggedIn
		};

		if (!this.loggedIn)
			args={
				layoutStr: layoutStringsModel,
				loggedIn: this.loggedIn,
				loginStr: loginStringsModel
			};

		this.$el.html(this.template(args));	
		this.prepareDialogs();
		this.initJS();
	
		if (this.contentView) 
			this.contentView.setElement('#content-div');
	}
});

var layoutView = new LayoutView();
var DialogView = Backbone.View.extend({
	el: '',
	template: '',	
	args: '',
	templateId: '',
	
	initialize: function() {
		this.template = _.template($(this.templateId).html());
	},

	initJS: function() {
		this.$el.modal();
	},

	render: function() {
		this.$el.html(this.template(this.args));
		this.initJS();
	}
});

var FAQView = DialogView.extend({
	args: {
		faqStr: faqStringsModel
	},
	templateId: '#faq-template'
});

var faqView = new FAQView();

var TutorialView = DialogView.extend({
	args: {
		layoutStr: layoutStringsModel
	},
	templateId: '#tutorial-template',

	initJS: function() {
		//From github.com/twitter/bootstrap/issues/675/

		var me=this;
		this.$el.modal().css({
			'margin-left': function() {
				return -($(this).width()/2);
			}
		}).addClass('tutorial').on('hidden', function() {
			me.$el.empty();
			me.$el.removeClass('tutorial');
		});
	}
});

var tutorialView = new TutorialView();
var SuggestionsStringsModel = Backbone.Model.extend({
	defaults: {
		'dialogTitle': 'Sugestões/Bugs/Comentários...',
		'submitButtonLabel': 'Enviar comentário',
		'resetButtonLabel': 'Limpar campo'
	}
});

var suggestionsStringsModel = new SuggestionsStringsModel();
var SuggestionsView = DialogView.extend({
	templateId: '#suggestions-template',
	args: {
		suggestionsStr: suggestionsStringsModel
	},

	suggestionsUrl: '/api/sugestao',
	
	events: {
		'submit #suggestions-form': 'sendSuggestion',
		'keypress textarea': 'toggleButton'
	},

	toggleButton: function(e) {
		var el = e.target;
		console.log(el);

		if(el.value.trim() == '')
			$('#suggestions-form input[type="submit"]').addClass('disabled');
		else
			$('#suggestions-form input[type="submit"]').removeClass('disabled');
	},
	
	sendSuggestion: function() {
		if ($('#suggestions-form input[type="submit"]').hasClass('disabled'))
			return false;		

		$.ajax({
			url: this.suggestionsUrl,
			type: 'POST',
			data: $('#suggestions-form').serialize(),

			success: function() {
				$('#dialogDiv').modal('hide');
			}
		});

		return false;	
	}
});

var suggestionsView = new SuggestionsView();
var TermStringsModel = Backbone.Model.extend({
	defaults: {
		'acceptCheckboxLabel': 'Eu aceito o termo de compromisso do PrISMA',
		'cancelButtonLabel': 'Não aceito',
		'acceptButtonLabel': 'Eu li e aceitei o termo de compromisso',
		'termText': 'Termo de Compromisso\n\n \
\tDeclaro que estou ciente que o sistema PrISMA não tem nenhuma responsabilidade \
quantos às grades geradas nele, assim como não se responsabiliza por possíveis \
erros que ele permitiu o usuário cometer. Também declaro ter conhecimento dos \
seguintes ítens:\n\n \
1/ Apenas alunos regularmente matriculados na PUC-Rio podem utilizar \
este sistema. A autenticação é a mesma do PUConline. \
\n\n \
2/ O uso do PrISMA por parte de alunos da PUC-Rio é opcional. Alunos \
podem efetivar sua 1a fase de matrícula diretamente pelo PUConline, sem \
auxílio do PrISMA. \
\n\n \
3/ O sistema PrISMA auxilia na montagem de 3 opções de matrícula do \
aluno da PUC-Rio, usando as informações do histórico, contemplando o \
"Falta Cursar", disciplinas que o aluno está cursando no atual período e \
também as disciplinas já concluídas com sucesso. \
\n\n \
4/ Importantíssimo: o PrISMA não realiza a matrícula em si! Após usar o \
sistema, o aluno precisa obrigatoriamente utilizar o PUConline e entrar \
com as opções propostas após utilizar o PrISMA. Não há como importar as \
escolhas definidas após utilização do PrISMA diretamente para o \
PUConline, trata-se de uma ação a ser realizada manualmente por cada aluno. \
\n\n \
5/ O uso do sistema PrISMA não garante nem aumenta as chances do aluno \
da PUC-Rio conseguir matrícula em uma ou mais das disciplinas oferecidas \
para o próximo semestre. Também não há como garantir que o resultado \
final do PrISMA de cada aluno corresponda à melhor solução possível para \
grade de horários do próximo semestre. \
\n\n \
6/ Na versão atual, o PrISMA verifica pré-requisitos básicos e permite \
orientar o aluno para matrículas em disciplinas que ele PODE CURSAR. \
Assim, o aluno perceberá que para algumas disciplinas não é permitida a \
escolha para alguma opção - caso não tenha pré-requisitos, por exemplo - \
ou então há um aviso de atenção para disciplinas sendo cursadas, pois \
uma vez o aluno aprovado não poderá solicitar na matrícula, ou ainda, \
pode ser alguma disciplina pré-requisito de outra. \
\n\n \
7/ O PrISMA não garante que você está apto a cursar todas as turmas \
escolhidas. Isso ocorre pois as turmas podem ser destinadas a certos cursos \
e esse tipo de checagem não está sendo feita nessa versão.'
	}
});

var termStringsModel = new TermStringsModel();
var TermView = Backbone.View.extend({
	el: '',
	template: '',

	events: {
		'click input[type="submit"]': 'checkAcceptance',
		'change input[type="checkbox"]': 'toggleContinueButton'
	},

	checkAcceptance: function() {
		if ($('input[type="checkbox"]').is(':checked'))
			return true;
		return false;
	},

	toggleContinueButton: function() {
		if ($('input[type="checkbox"]').is(':checked'))
			$('input[type="submit"]').removeClass('disabled');
		else
			$('input[type="submit"]').addClass('disabled');	
	},

	initialize: function() {
		this.template = _.template($("#term-template").html());
	},

	render: function() {
		this.$el.html(this.template({
			termStr: termStringsModel
		}));
	}
});

var termView = new TermView();
var TermRouter = Backbone.Router.extend({
	routes: {
		'': 'term'
	},

	loadPage: function() {
		layoutStringsModel.set('userName',DATA_VIEW.NomeAluno);
	
		layoutView.setView(termView);
		layoutView.loggedIn=true;
		layoutView.render();		

		termView.render();
	}
});

var termRouter = new TermRouter();
termRouter.on('route:term', function() {
	this.loadPage();
});

//if (history.pushState) { 
//	console.log("pushState supported");
//	Backbone.history.start({pushState: true});
//}
//else {
//	console.log("pushState NOT supported");
	Backbone.history.start();
//}
